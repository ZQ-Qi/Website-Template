/*!
 * v0.0.9
 * Copyright (c) 2013 First Opinion
 * formatter.js is open sourced under the MIT license.
 *
 * thanks to digitalBush/jquery.maskedinput for some of the trickier
 * keycode handling
 */ 

(function(f,n,s,p){function e(a,b){var c=this;c.el=a;if(!c.el)throw new TypeError("Must provide an existing element");c.opts=d.extend({},t,b);"undefined"!==typeof c.opts.pattern&&(c.opts.patterns=c._specFromSinglePattern(c.opts.pattern),delete c.opts.pattern);if("undefined"===typeof c.opts.patterns)throw new TypeError("Must provide a pattern or array of patterns");c.patternMatcher=q(c.opts.patterns);c._updatePattern();c.hldrs={};c.focus=0;d.addListener(c.el,"keydown",function(a){c._keyDown(a)});d.addListener(c.el,
"keypress",function(a){c._keyPress(a)});d.addListener(c.el,"paste",function(a){c._paste(a)});c.opts.persistent&&(c._processKey("",!1),c.el.blur(),d.addListener(c.el,"focus",function(a){c._focus(a)}),d.addListener(c.el,"click",function(a){c._focus(a)}),d.addListener(c.el,"touchstart",function(a){c._focus(a)}))}function q(a){var b=[],c=[];d.forEach(a,function(a){d.forEach(a,function(a,d){var u=r.parse(a),e;e="*"===d?/.*/:RegExp(d);b.push(e);c.push(u);return!1})});return{getPattern:function(a){var e;
d.forEach(b,function(c,b){if(c.test(a))return e=b,!1});return e===p?null:c[e]},patterns:c,matchers:b}}var t={persistent:!1,repeat:!1,placeholder:" "},h={9:/[0-9]/,a:/[A-Za-z]/,"*":/[A-Za-z0-9]/};e.addInptType=function(a,b){h[a]=b};e.prototype.resetPattern=function(a){this.opts.patterns=a?this._specFromSinglePattern(a):this.opts.patterns;this.sel=k.get(this.el);this.val=this.el.value;this.delta=0;this._removeChars();this.patternMatcher=q(this.opts.patterns);a=this.patternMatcher.getPattern(this.val);
this.mLength=a.mLength;this.chars=a.chars;this.inpts=a.inpts;this._processKey("",!1,!0)};e.prototype._updatePattern=function(){var a=this.patternMatcher.getPattern(this.val);a&&(this.mLength=a.mLength,this.chars=a.chars,this.inpts=a.inpts)};e.prototype._keyDown=function(a){var b=a.which||a.keyCode;if(b&&d.isDelKey(b))return this._processKey(null,b),d.preventDefault(a)};e.prototype._keyPress=function(a){var b,c;a.which?b=a.which:(b=a.keyCode,c=d.isSpecialKey(b));if(!d.isDelKey(b)&&!c&&!d.isModifier(a))return this._processKey(String.fromCharCode(b),
!1),d.preventDefault(a)};e.prototype._paste=function(a){this._processKey(d.getClip(a),!1);return d.preventDefault(a)};e.prototype._focus=function(){var a=this;setTimeout(function(){var b=k.get(a.el),c=0===b.end;(b.end>a.focus||c)&&k.set(a.el,a.focus)},0)};e.prototype._processKey=function(a,b,c){this.sel=k.get(this.el);this.val=this.el.value;this.delta=0;if(this.sel.begin!==this.sel.end)this.delta=-1*Math.abs(this.sel.begin-this.sel.end),this.val=d.removeChars(this.val,this.sel.begin,this.sel.end);
else if(b&&46==b)this._delete();else if(b&&0<=this.sel.begin-1){for(this.delta-=1;this.chars[this.focus-1];)this.delta--,this.focus--;this.val=d.removeChars(this.val,this.sel.end+this.delta,this.sel.end)}else if(b)return!0;b||(this.val=d.addChars(this.val,a,this.sel.begin),this.delta+=a.length);this._formatValue(c)};e.prototype._delete=function(){for(;this.chars[this.sel.begin];)this._nextPos();this.sel.begin<this.val.length&&(this._nextPos(),this.val=d.removeChars(this.val,this.sel.end-1,this.sel.end),
this.delta=-1)};e.prototype._nextPos=function(){this.sel.end++;this.sel.begin++};e.prototype._formatValue=function(a){this.newPos=this.sel.end+this.delta;this._removeChars();this._updatePattern();this._validateInpts();this._addChars();this.el.value=this.val.substr(0,this.mLength);"undefined"!==typeof a&&!1!==a||k.set(this.el,this.newPos)};e.prototype._removeChars=function(){this.sel.end>this.focus&&(this.delta+=this.sel.end-this.focus);for(var a=0,b=0;b<=this.mLength;b++){var c=this.chars[b],e=this.hldrs[b],
l=b+a,m,l=b>=this.sel.begin?l+this.delta:l;m=this.val.charAt(l);if(c&&c==m||e&&e==m)this.val=d.removeChars(this.val,l,l+1),a--}this.hldrs={};this.focus=this.val.length};e.prototype._validateInpts=function(){for(var a=0;a<this.val.length;a++){var b=this.inpts[a],c=!h[b],b=!c&&!h[b].test(this.val.charAt(a)),e=this.inpts[a];(c||b)&&e&&(this.val=d.removeChars(this.val,a,a+1),this.focusStart--,this.newPos--,this.delta--,a--)}};e.prototype._addChars=function(){if(this.opts.persistent){for(var a=0;a<=this.mLength;a++)this.val.charAt(a)||
(this.val=d.addChars(this.val,this.opts.placeholder,a),this.hldrs[a]=this.opts.placeholder),this._addChar(a);for(;this.chars[this.focus];)this.focus++}else for(a=0;a<=this.val.length;a++){if(0>=this.delta&&a===this.focus&&this.chars[a]===p||0===this.focus)return!0;this._addChar(a)}};e.prototype._addChar=function(a){var b=this.chars[a];if(!b)return!0;d.isBetween(a,[this.sel.begin-1,this.newPos+1])&&(this.newPos++,this.delta++);a<=this.focus&&this.focus++;this.hldrs[a]&&(delete this.hldrs[a],this.hldrs[a+
1]=this.opts.placeholder);this.val=d.addChars(this.val,b,a)};e.prototype._specFromSinglePattern=function(a){return[{"*":a}]};var r={},v=RegExp("{{([^}]+)}}","g");r.parse=function(a){for(var b={inpts:{},chars:{}},c=[],d;d=v.exec(a);)c.push(d);d=a.length;var e=0,m=0,g=0;for(g;g<d;g++)if(e<c.length&&g==c[e].index){for(var f=c[e][1],k=f.length,h=0;h<k;h++)b.inpts[m]=f.charAt(h),m++;e++;g+=f.length+4-1}else b.chars[g-4*e]=a.charAt(g);b.mLength=g-4*e;return b};var k={get:function(a){if("number"==typeof a.selectionStart)return{begin:a.selectionStart,
end:a.selectionEnd};var b=s.selection.createRange();if(b&&b.parentElement()==a){var c=a.createTextRange(),d=a.createTextRange();a=a.value.length;c.moveToBookmark(b.getBookmark());d.collapse(!1);return-1<c.compareEndPoints("StartToEnd",d)?{begin:a,end:a}:{begin:-c.moveStart("character",-a),end:-c.moveEnd("character",-a)}}return{begin:0,end:0}},set:function(a,b){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0);c.moveEnd("character",
b);c.moveStart("character",b);c.select()}}},d={},w=/iphone/i.test("undefined"!==typeof navigator?navigator.userAgent:null);d.extend=function(a){for(var b=1;b<arguments.length;b++)for(var c in arguments[b])a[c]=arguments[b][c];return a};d.addChars=function(a,b,c){return a.substr(0,c)+b+a.substr(c,a.length)};d.removeChars=function(a,b,c){return a.substr(0,b)+a.substr(c,a.length)};d.isBetween=function(a,b){b.sort(function(a,b){return a-b});return a>b[0]&&a<b[1]};d.addListener=function(a,b,c){return"undefined"!=
typeof a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)};d.preventDefault=function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1};d.getClip=function(a){if(a.clipboardData)return a.clipboardData.getData("Text");if(n.clipboardData)return n.clipboardData.getData("Text")};d.isDelKey=function(a){return 8===a||46===a||w&&127===a};d.isSpecialKey=function(a){return{9:"tab",13:"enter",35:"end",36:"home",37:"leftarrow",38:"uparrow",39:"rightarrow",40:"downarrow",116:"F5"}[a]};
d.isModifier=function(a){return a.ctrlKey||a.altKey||a.metaKey};d.forEach=function(a,b,c){if(a.hasOwnProperty("length"))for(var d=0,e=a.length;d<e&&!1!==b.call(c,a[d],d,a);d++);else for(d in a)if(a.hasOwnProperty(d)&&!1===b.call(c,a[d],d,a))break};f.fn.formatter=function(a){"object"==typeof a&&this.each(function(){f.data(this,"plugin_formatter")||f.data(this,"plugin_formatter",new e(this,a))});this.resetPattern=function(a){this.each(function(){var c=f.data(this,"plugin_formatter");c&&c.resetPattern(a)});
return this};return this};f.fn.formatter.addInptType=function(a,b){e.addInptType(a,b)}})(jQuery,window,document);
