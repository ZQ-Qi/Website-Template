!function(t){"use strict";var e=function(e,n){this.$ns="bootstrap-markdown",this.$element=t(e),this.$editable={el:null,type:null,attrKeys:[],attrValues:[],content:null},this.$options=t.extend(!0,{},t.fn.markdown.defaults,n),this.$oldContent=null,this.$isPreview=!1,this.$editor=null,this.$textarea=null,this.$handler=[],this.$callback=[],this.$nextTab=[],this.showEditor()};e.prototype={constructor:e,__alterButtons:function(e,n){var a=this.$handler,i="all"==e,r=this;t.each(a,function(t,a){var s=!0;s=i?!1:a.indexOf(e)<0,0==s&&n(r.$editor.find('button[data-handler="'+a+'"]'))})},__buildButtons:function(e,n){var a,i=this.$ns,r=this.$handler,s=this.$callback;for(a=0;a<e.length;a++){var o,l=e[a];for(o=0;o<l.length;o++){var c,d=l[o].data,h=t("<div/>",{"class":"btn-group"});for(c=0;c<d.length;c++){var u=d[c],f="",p=i+"-"+u.name,v=u.btnText?u.btnText:"",m=u.btnClass?u.btnClass:"btn",b=u.tabIndex?u.tabIndex:"-1";1==u.toggle&&(f=' data-toggle="button"'),h.append('<button class="'+m+' btn-default btn-sm" title="'+u.title+'" tabindex="'+b+'" data-provider="'+i+'" data-handler="'+p+'"'+f+'><span class="'+u.icon+'"></span> '+v+"</button>"),r.push(p),s.push(u.callback)}n.append(h)}}return n},__setListener:function(){var e="undefined"!=typeof this.$textarea.attr("rows"),n=this.$textarea.val().split("\n").length>5?this.$textarea.val().split("\n").length:"5",a=e?this.$textarea.attr("rows"):n;this.$textarea.attr("rows",a),this.$textarea.css("resize","none"),this.$textarea.on("focus",t.proxy(this.focus,this)).on("keypress",t.proxy(this.keypress,this)).on("keyup",t.proxy(this.keyup,this)),this.eventSupported("keydown")&&this.$textarea.on("keydown",t.proxy(this.keydown,this)),this.$textarea.data("markdown",this)},__handle:function(e){var n=t(e.currentTarget),a=this.$handler,i=this.$callback,r=n.attr("data-handler"),s=a.indexOf(r),o=i[s];t(e.currentTarget).focus(),o(this),r.indexOf("cmdSave")<0&&this.$textarea.focus(),e.preventDefault()},showEditor:function(){var e,n=this,a=this.$ns,i=this.$element,r=(i.css("height"),i.css("width"),this.$editable),s=this.$handler,o=this.$callback,l=this.$options,c=t("<div/>",{"class":"md-editor",click:function(){n.focus()}});if(null==this.$editor){var d=t("<div/>",{"class":"md-header btn-toolbar"});if(l.buttons.length>0&&(d=this.__buildButtons(l.buttons,d)),l.additionalButtons.length>0&&(d=this.__buildButtons(l.additionalButtons,d)),c.append(d),i.is("textarea"))i.before(c),e=i,e.addClass("md-input"),c.append(e);else{var h="function"==typeof toMarkdown?toMarkdown(i.html()):i.html(),u=t.trim(h);e=t("<textarea/>",{"class":"md-input",val:u}),c.append(e),r.el=i,r.type=i.prop("tagName").toLowerCase(),r.content=i.html(),t(i[0].attributes).each(function(){r.attrKeys.push(this.nodeName),r.attrValues.push(this.nodeValue)}),i.replaceWith(c)}if(l.savable){var f=t("<div/>",{"class":"md-footer"}),p="cmdSave";s.push(p),o.push(l.onSave),f.append('<button class="btn btn-success" data-provider="'+a+'" data-handler="'+p+'"><i class="icon icon-white icon-ok"></i> Save</button>'),c.append(f)}t.each(["height","width"],function(t,e){"inherit"!=l[e]&&(jQuery.isNumeric(l[e])?c.css(e,l[e]+"px"):c.addClass(l[e]))}),this.$editor=c,this.$textarea=e,this.$editable=r,this.$oldContent=this.getContent(),this.__setListener(),this.$editor.attr("id",(new Date).getTime()),this.$editor.on("click",'[data-provider="bootstrap-markdown"]',t.proxy(this.__handle,this))}else this.$editor.show();return l.autofocus&&(this.$textarea.focus(),this.$editor.addClass("active")),l.onShow(this),this},showPreview:function(){var e,n=this.$options,a=n.onPreview(this),i=this.$textarea,r=i.next(),s=t("<div/>",{"class":"md-preview","data-provider":"markdown-preview"});return this.$isPreview=!0,this.disableButtons("all").enableButtons("cmdPreview"),e="string"==typeof a?a:"object"==typeof markdown?markdown.toHTML(i.val()):i.val(),s.html(e),r&&"md-footer"==r.attr("class")?s.insertBefore(r):i.parent().append(s),i.hide(),s.data("markdown",this),this},hidePreview:function(){this.$isPreview=!1;var t=this.$editor.find('div[data-provider="markdown-preview"]');return t.remove(),this.enableButtons("all"),this.$textarea.show(),this.__setListener(),this},isDirty:function(){return this.$oldContent!=this.getContent()},getContent:function(){return this.$textarea.val()},setContent:function(t){return this.$textarea.val(t),this},findSelection:function(t){var e,n=this.getContent();if(e=n.indexOf(t),e>=0&&t.length>0){var a,i=this.getSelection();return this.setSelection(e,e+t.length),a=this.getSelection(),this.setSelection(i.start,i.end),a}return null},getSelection:function(){var t=this.$textarea[0];return("selectionStart"in t&&function(){var e=t.selectionEnd-t.selectionStart;return{start:t.selectionStart,end:t.selectionEnd,length:e,text:t.value.substr(t.selectionStart,e)}}||function(){return null})()},setSelection:function(t,e){var n=this.$textarea[0];return("selectionStart"in n&&function(){n.selectionStart=t,n.selectionEnd=e}||function(){return null})()},replaceSelection:function(t){var e=this.$textarea[0];return("selectionStart"in e&&function(){return e.value=e.value.substr(0,e.selectionStart)+t+e.value.substr(e.selectionEnd,e.value.length),e.selectionStart=e.value.length,this}||function(){return e.value+=t,jQuery(e)})()},getNextTab:function(){if(0==this.$nextTab.length)return null;var t,e=this.$nextTab.shift();return"function"==typeof e?t=e():"object"==typeof e&&e.length>0&&(t=e),t},setNextTab:function(t,e){if("string"==typeof t){var n=this;this.$nextTab.push(function(){return n.findSelection(t)})}else if("numeric"==typeof t&&"numeric"==typeof e){var a=this.getSelection();this.setSelection(t,e),this.$nextTab.push(this.getSelection()),this.setSelection(a.start,a.end)}},enableButtons:function(t){var e=function(t){t.removeAttr("disabled")};return this.__alterButtons(t,e),this},disableButtons:function(t){var e=function(t){t.attr("disabled","disabled")};return this.__alterButtons(t,e),this},eventSupported:function(t){var e=t in this.$element;return e||(this.$element.setAttribute(t,"return;"),e="function"==typeof this.$element[t]),e},keydown:function(e){this.suppressKeyPressRepeat=~t.inArray(e.keyCode,[40,38,9,13,27]),this.keyup(e)},keypress:function(t){this.suppressKeyPressRepeat||this.keyup(t)},keyup:function(t){var e=!1;switch(t.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:var n;if(n=this.getNextTab(),null!=n){var a=this;setTimeout(function(){a.setSelection(n.start,n.end)},500),e=!0}else{var i=this.getSelection();i.start==i.end&&i.end==this.getContent().length?e=!1:(this.setSelection(this.getContent().length,this.getContent().length),e=!0)}break;case 13:case 27:e=!1;break;default:e=!1}e&&(t.stopPropagation(),t.preventDefault())},focus:function(){var e=this.$options,n=(e.hideable,this.$editor);return n.addClass("active"),t(document).find(".md-editor").each(function(){if(t(this).attr("id")!=n.attr("id")){var e;e=t(this).find("textarea").data("markdown"),null==e&&(e=t(this).find('div[data-provider="markdown-preview"]').data("markdown")),e&&e.blur()}}),this},blur:function(){var e=this.$options,n=e.hideable,a=this.$editor,i=this.$editable;if(a.hasClass("active")||0==this.$element.parent().length){if(a.removeClass("active"),n)if(null!=i.el){var r=t("<"+i.type+"/>"),s=this.getContent(),o="object"==typeof markdown?markdown.toHTML(s):s;t(i.attrKeys).each(function(t){r.attr(i.attrKeys[t],i.attrValues[t])}),r.html(o),a.replaceWith(r)}else a.hide();e.onBlur(this)}return this}};var n=t.fn.markdown;t.fn.markdown=function(n){return this.each(function(){var a=t(this),i=a.data("markdown"),r="object"==typeof n&&n;i||a.data("markdown",i=new e(this,r))})},t.fn.markdown.defaults={autofocus:!1,hideable:!1,savable:!1,width:"inherit",height:"inherit",buttons:[[{name:"groupFont",data:[{name:"cmdBold",title:"Bold",icon:"fa fa-bold",callback:function(t){var e,n,a=t.getSelection(),i=t.getContent();e=0==a.length?"strong text":a.text,"**"==i.substr(a.start-2,2)&&"**"==i.substr(a.end,2)?(t.setSelection(a.start-2,a.end+2),t.replaceSelection(e),n=a.start-2):(t.replaceSelection("**"+e+"**"),n=a.start+2),t.setSelection(n,n+e.length)}},{name:"cmdItalic",title:"Italic",icon:"fa fa-italic",callback:function(t){var e,n,a=t.getSelection(),i=t.getContent();e=0==a.length?"emphasized text":a.text,"*"==i.substr(a.start-1,1)&&"*"==i.substr(a.end,1)?(t.setSelection(a.start-1,a.end+1),t.replaceSelection(e),n=a.start-1):(t.replaceSelection("*"+e+"*"),n=a.start+1),t.setSelection(n,n+e.length)}},{name:"cmdHeading",title:"Heading",icon:"fa fa-font",callback:function(t){var e,n,a,i,r=t.getSelection(),s=t.getContent();e=0==r.length?"heading text":r.text+"\n",a=4,"### "==s.substr(r.start-a,a)||(a=3,"###"==s.substr(r.start-a,a))?(t.setSelection(r.start-a,r.end),t.replaceSelection(e),n=r.start-a):r.start>0&&(i=s.substr(r.start-1,1),!!i&&"\n"!=i)?(t.replaceSelection("\n\n### "+e),n=r.start+6):(t.replaceSelection("### "+e),n=r.start+4),t.setSelection(n,n+e.length)}}]},{name:"groupLink",data:[{name:"cmdUrl",title:"URL/Link",icon:"fa fa-globe",callback:function(t){{var e,n,a,i=t.getSelection();t.getContent()}e=0==i.length?"enter link description here":i.text,a=prompt("Insert Hyperlink","http://"),null!=a&&""!=a&&"http://"!=a&&(t.replaceSelection("["+e+"]("+a+")"),n=i.start+1,t.setSelection(n,n+e.length))}},{name:"cmdImage",title:"Image",icon:"fa fa-picture-o",callback:function(t){{var e,n,a,i=t.getSelection();t.getContent()}e=0==i.length?"enter image description here":i.text,a=prompt("Insert Image Hyperlink","http://"),null!=a&&(t.replaceSelection("!["+e+"]("+a+' "enter image title here")'),n=i.start+2,t.setNextTab("enter image title here"),t.setSelection(n,n+e.length))}}]},{name:"groupMisc",data:[{name:"cmdList",title:"List",icon:"fa fa-list",callback:function(e){{var n,a,i=e.getSelection();e.getContent()}if(0==i.length)n="list text here",e.replaceSelection("- "+n),a=i.start+2;else if(i.text.indexOf("\n")<0)n=i.text,e.replaceSelection("- "+n),a=i.start+2;else{var r=[];r=i.text.split("\n"),n=r[0],t.each(r,function(t,e){r[t]="- "+e}),e.replaceSelection("\n\n"+r.join("\n")),a=i.start+4}e.setSelection(a,a+n.length)}}]},{name:"groupUtil",data:[{name:"cmdPreview",toggle:!0,title:"Preview",btnText:"Preview",btnClass:"btn btn-primary btn-sm",icon:"fa fa-search",callback:function(t){var e=t.$isPreview;0==e?t.showPreview():t.hidePreview()}}]}]],additionalButtons:[],onShow:function(){},onPreview:function(){},onSave:function(){},onBlur:function(){}},t.fn.markdown.Constructor=e,t.fn.markdown.noConflict=function(){return t.fn.markdown=n,this};var a=function(t){var e=t;return e.data("markdown")?(e.data("markdown").showEditor(),void 0):(e.markdown(e.data()),void 0)},i=function(e){var n,a=!1,i=t(e.currentTarget);"focusin"!=e.type&&"click"!=e.type||1!=i.length||"object"!=typeof i[0]||(n=i[0].activeElement,t(n).data("markdown")||("undefined"==typeof t(n).parent().parent().parent().attr("class")||t(n).parent().parent().parent().attr("class").indexOf("md-editor")<0?("undefined"==typeof t(n).parent().parent().attr("class")||t(n).parent().parent().attr("class").indexOf("md-editor")<0)&&(a=!0):a=!1),a&&t(document).find(".md-editor").each(function(){var e=t(n).parent();if(t(this).attr("id")!=e.attr("id")){var a;a=t(this).find("textarea").data("markdown"),null==a&&(a=t(this).find('div[data-provider="markdown-preview"]').data("markdown")),a&&a.blur()}}),e.stopPropagation())};t(document).on("click.markdown.data-api",'[data-provide="markdown-editable"]',function(e){a(t(this)),e.preventDefault()}).on("click",function(t){i(t)}).on("focusin",function(t){i(t)}).ready(function(){t('textarea[data-provide="markdown"]').each(function(){a(t(this))})})}(window.jQuery);