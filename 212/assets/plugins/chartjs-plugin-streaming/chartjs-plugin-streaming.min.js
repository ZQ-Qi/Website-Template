/*
 * @license
 * chartjs-plugin-streaming
 * https://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.6.1
 *
 * Copyright 2018 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],t):e["chartjs-plugin-streaming"]=t(e.Chart,e.moment)}(this,function(e,t){"use strict";!function(e,h){var b=e.helpers;b.cancelAnimFrame=function(){if("undefined"!=typeof window)return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){return window.clearTimeout(e)}}();var t,n,v=Number.MAX_SAFE_INTEGER||9007199254740991,g={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},y=Object.keys(g);function x(e){for(var t=y.indexOf(e)+1,i=y.length;t<i;++t)if(g[y[t]].common)return y[t]}function p(e,t,i,n,a){var o,r=n.time,s=r.unit||function(e,t,i,n){var a,o,r,s=y.length;for(a=y.indexOf(e);a<s-1;++a)if(r=(o=g[y[a]]).steps?o.steps[o.steps.length-1]:v,o.common&&Math.ceil((i-t)/(r*o.size))<=n)return y[a];return y[s-1]}(r.minUnit,e,t,i),l=x(s),u=b.valueOrDefault(r.stepSize,r.unitStepSize),c="week"===s&&r.isoWeekday,m=g[s],d=h(e),p=h(t+a),f=[];for(u||(u=function(e,t,i,n){var a,o,r,s=t-e,l=g[i],u=l.size,c=l.steps;if(!c)return Math.ceil(s/(n*u));for(a=0,o=c.length;a<o&&(r=c[a],!(Math.ceil(s/(u*r))<=n));++a);return r}(e,t,s,i)),c&&(d=d.isoWeekday(c),p=p.isoWeekday(c)),d=d.startOf(c?"day":s),(p=p.startOf(c?"day":s))<t+a&&p.add(1,s),o=h(d),!l||c||r.round||(o.startOf(l),o.add(~~((d-o)/(m.size*u))*u,s));o<p;o.add(u,s))f.push(+o);return f.push(+o),f}void 0!==document.hidden?(t="hidden",n="visibilitychange"):void 0!==document.msHidden?(t="msHidden",n="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",n="webkitvisibilitychange");var D={data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},M={data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]};function A(e,t,i){var n,a,o=e._start||{},r=e._view||{},s=e._model||{};for(n=0,a=t.length;n<a;++n){var l=t[n];o.hasOwnProperty(l)&&(o[l]-=i),r.hasOwnProperty(l)&&r!==o&&(r[l]-=i),s.hasOwnProperty(l)&&s!==r&&(s[l]-=i)}}var f=e.scaleService.getScaleConstructor("time");e.scaleService.getScaleConstructor=function(e){return"time"===e&&(e="realtime"),this.constructors.hasOwnProperty(e)?this.constructors[e]:void 0};var i=f.extend({initialize:function(){var h=this,v=h.chart;if(f.prototype.initialize.apply(h,arguments),"time"!==h.options.type||v.options.plugins.streaming){var g=b.requestAnimFrame,y=h.realtime=h.realtime||{},x=0,e=function(){document[t]||(y.head=Date.now(),v.update({duration:0}))};document.addEventListener(n,e,!1),y.visibilityChangeListener=e;var w=function(){var o,e,r,t=b.valueOrDefault,i=h.options.realtime||{},n=v.options.plugins.streaming||{},a=t(i.duration,n.duration),s=t(i.delay,n.delay),l=t(i.frameRate,n.frameRate),u=h.id,c=v.tooltip,m=c._active,d=1e3/(Math.max(l,0)||30);o=h.isHorizontal()?(e=h.width,D):(e=h.height,M);var p=Date.now(),f=e*(p-y.head)/a;b.each(v.data.datasets,function(e,t){if(r=v.getDatasetMeta(t),u===r.xAxisID||u===r.yAxisID){var i,n,a=r.data||[];for(i=0,n=a.length;i<n;++i)A(a[i],o.data,f);r.dataset&&A(r.dataset,o.dataset,f)}}),m&&m[0]&&(r=v.getDatasetMeta(m[0]._datasetIndex),u!==r.xAxisID&&u!==r.yAxisID||A(c,o.tooltip,f)),h.max=h._table[1].time=p-s,h.min=h._table[0].time=h.max-a,x+d<=p&&(v.animating||c._start||v.draw(),v.streaming.onDraw(v),(x+=d)+d<=p&&(x=p)),y.head=p,y.frameRequestID=g.call(window,w)};y.head=Date.now(),y.frameRequestID=g.call(window,w)}},update:function(){var e=this,t=e.options,i=e.chart;if("time"===t.type&&!i.options.plugins.streaming)return f.prototype.update.apply(e,arguments);var n=e.realtime.frameRequestID,a=(i.options.plugins.streaming||{}).pause;return n||a?n&&a&&e.destroy():e.initialize(),f.prototype.update.apply(e,arguments)},buildTicks:function(){var e=this,t=e.options,i=e.chart;if("time"===t.type&&!i.options.plugins.streaming)return f.prototype.buildTicks.apply(e,arguments);var n=b.valueOrDefault,a=t.time,o=t.realtime||{},r=i.options.plugins.streaming||{},s=n(o.duration,r.duration),l=n(o.delay,r.delay),u=n(r.refresh,0),c=e.realtime.head-l,m=c-s,d=[];switch(t.ticks.source){case"data":d=e._timestamps.data;break;case"labels":d=e._timestamps.labels;break;case"auto":default:d=p(m,c,e.getLabelCapacity(m),t,u)}return e.min=m,e.max=c,e._unit=a.unit||function(e,t,i,n){var a,o,r=h.duration(h(n).diff(h(i)));for(a=y.length-1;a>=y.indexOf(t);a--)if(o=y[a],g[o].common&&r.as(o)>=e.length)return o;return y[t?y.indexOf(t):0]}(d,a.minUnit,e.min,e.max),e._majorUnit=x(e._unit),e._table=[{time:m,pos:0},{time:c,pos:1}],e._offsets={left:0,right:0},e._labelFormat=function(e,t){var i,n,a,o,r,s,l,u=e.length;for(i=0;i<u;i++){if(o=e[i],l=s=void 0,s=(r=t).parser,l=r.parser||r.format,0!==(n="function"==typeof s?s(o):"string"==typeof o&&"string"==typeof l?h(o,l):(o instanceof h||(o=h(o)),o.isValid()?o:"function"==typeof l?l(o):o)).millisecond())return"MMM D, YYYY h:mm:ss.SSS a";0===n.second()&&0===n.minute()&&0===n.hour()||(a=!0)}return a?"MMM D, YYYY h:mm:ss a":"MMM D, YYYY"}(e._timestamps.data,a),function(e,t){var i,n,a,o,r=[];for(i=0,n=e.length;i<n;++i)a=e[i],o=!!t&&a===+h(a).startOf(t),r.push({value:a,major:o});return r}(d,e._majorUnit)},fit:function(){var e=this,t=e.options;f.prototype.fit.apply(e,arguments),("time"!==t.type||e.chart.options.plugins.streaming)&&t.ticks.display&&t.display&&e.isHorizontal()&&(e.paddingLeft=3,e.paddingRight=3,e.handleMargins())},draw:function(e){var t=this,i=t.chart;if("time"!==t.options.type||i.options.plugins.streaming){var n=t.ctx,a=t.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:i.height}:{left:0,top:e.top,right:i.width,bottom:e.bottom};b.canvas.clipArea(n,a),f.prototype.draw.apply(t,arguments),b.canvas.unclipArea(n)}else f.prototype.draw.apply(t,arguments)},destroy:function(){var e=this.realtime,t=e.visibilityChangeListener,i=e.frameRequestID;t&&(document.removeEventListener(n,t,!1),delete e.visibilityChangeListener),i&&(b.cancelAnimFrame.call(window,i),delete e.frameRequestID)}});e.scaleService.registerScaleType("realtime",i,{position:"bottom",distribution:"linear",bounds:"data",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},realtime:{},ticks:{autoSkip:!1,source:"auto",major:{enabled:!0}}})}(e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t);var i=function(c){var m=c.helpers;c.defaults.global.plugins.streaming={duration:1e4,delay:0,frameRate:30,refresh:1e3,onRefresh:null,pause:!1,ttl:void 0};var d=c.scaleService.getScaleConstructor("realtime");function p(e){var t,i=e.streaming.lastMouseEvent;i&&("function"==typeof MouseEvent?t=new MouseEvent("mousemove",i):(t=document.createEvent("MouseEvents")).initMouseEvent("mousemove",i.bubbles,i.cancelable,i.view,i.detail,i.screenX,i.screenY,i.clientX,i.clientY,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.button,i.relatedTarget),e.canvas.dispatchEvent(t))}var u=["pointBackgroundColor","pointBorderColor","pointBorderWidth","pointRadius","pointStyle","pointHitRadius","pointHoverBackgroundColor","pointHoverBorderColor","pointHoverBorderWidth","pointHoverRadius","backgroundColor","borderColor","borderWidth","hoverBackgroundColor","hoverBorderColor","hoverBorderWidth","hoverRadius","hitRadius","radius"];function f(e,t,i,n,a){var o,r,s=n.data,l=2;for(isNaN(i)||(t=e.getPixelForValue(Date.now()-i),l=0),o=l,r=s.length;o<r&&e.getPixelForValue(null,o,a)<=t;++o);if(s.splice(0,o-l),u.forEach(function(e){n.hasOwnProperty(e)&&m.isArray(n[e])&&n[e].splice(0,o-l)}),"object"!=typeof s[0])return o-l}function a(i){var n,a,o,r,e,t,s,l=i.options.plugins.streaming||{},u=l.ttl;l.onRefresh&&l.onRefresh(i),i.data.datasets.forEach(function(e,t){(n=i.getDatasetMeta(t)).xAxisID&&(a=n.controller.getScaleForId(n.xAxisID))instanceof d&&(o=f(a,a.left,u,e,t)),n.yAxisID&&(a=n.controller.getScaleForId(n.yAxisID))instanceof d&&(o=f(a,a.top,u,e,t))}),o&&i.data.labels.splice(0,o),e=(r=i).options.animation,t=r.data.datasets,s=r.buildOrUpdateControllers(),t.forEach(function(e,t){r.getDatasetMeta(t).controller.buildOrUpdateElements()}),r.updateLayout(),e&&e.duration&&m.each(s,function(e){e.reset()}),r.updateDatasets(),r.animating?c.animationService.animations.forEach(function(e){e.chart===r&&r.render({duration:16.66*(e.numSteps-e.currentStep)})}):t.forEach(function(e,t){r.getDatasetMeta(t).controller.transition(1)}),r.tooltip._active&&r.tooltip.update(!0),p(r)}function o(e){var t=e.streaming,i=t.refreshTimerID;i&&(clearInterval(i),delete t.refreshTimerID,delete t.refresh)}return{id:"streaming",beforeInit:function(e){var t=e.streaming=e.streaming||{},i=t.canvas=e.canvas,n=t.mouseEventListener=function(e){t.lastMouseEvent=e};i.addEventListener("mousedown",n),i.addEventListener("mouseup",n),t.onDraw=p},afterInit:function(e,t){e.resetZoom&&c.Zoom.updateResetZoom(e),function t(i,e){var n=i.streaming;n.refreshTimerID=setInterval(function(){var e=(i.options.plugins.streaming||{}).refresh;a(i),n.refresh===e||isNaN(e)||(o(i),t(i,e))},e),n.refresh=e}(e,t.refresh)},beforeUpdate:function(e){var t=e.options,i=t.scales;return i&&i.xAxes.concat(i.yAxes).forEach(function(e){"realtime"!==e.type&&"time"!==e.type||(t.elements.line.capBezierPoints=!1)}),!0},beforeDatasetDraw:function(e,t){var i=t.meta,n=e.chartArea,a={left:0,top:0,right:e.width,bottom:e.height};return i.xAxisID&&i.controller.getScaleForId(i.xAxisID)instanceof d&&(a.left=n.left,a.right=n.right),i.yAxisID&&i.controller.getScaleForId(i.yAxisID)instanceof d&&(a.top=n.top,a.bottom=n.bottom),m.canvas.clipArea(e.ctx,a),!0},afterDatasetDraw:function(e){m.canvas.unclipArea(e.ctx)},beforeEvent:function(e,t){var i=e.streaming;return"mousemove"===t.type?i.lastMouseEvent=t.native:"mouseout"===t.type&&delete i.lastMouseEvent,!0},destroy:function(e){var t=e.streaming,i=t.canvas,n=t.mouseEventListener;i.removeEventListener("mousedown",n),i.removeEventListener("mouseup",n),o(e),m.each(e.scales,function(e){e instanceof d&&e.destroy()})}}}(e);return e.plugins.register(i),function(e){var d=e.helpers,t=e.Zoom=e.Zoom||{};function p(e,t){if(e.scaleAxes&&e.rangeMax&&!d.isNullOrUndef(e.rangeMax[e.scaleAxes])){var i=e.rangeMax[e.scaleAxes];i<t&&(t=i)}return t}function f(e,t){if(e.scaleAxes&&e.rangeMin&&!d.isNullOrUndef(e.rangeMin[e.scaleAxes])){var i=e.rangeMin[e.scaleAxes];t<i&&(t=i)}return t}t.zoomFunctions=t.zoomFunctions||{},t.panFunctions=t.panFunctions||{},t.zoomFunctions.realtime=function(e,t,i,n){var a,o,r=e.options,s=r.realtime=r.realtime,l=e.chart.options.plugins.streaming||{},u=d.valueOrDefault(s.duration,l.duration),c=d.valueOrDefault(s.delay,l.delay),m=u*(2-t);a=e.isHorizontal()?(e.right-i.x)/(e.right-e.left):(e.bottom-i.y)/(e.bottom-e.top),o=t<1?p(n,m):f(n,m),s.duration=o,s.delay=c+a*(u-o)},t.panFunctions.realtime=function(e,t,i){var n=e.options,a=n.realtime=n.realtime,o=e.chart.options.plugins.streaming||{},r=d.valueOrDefault(a.delay,o.delay)+(e.getValueForPixel(t)-e.getValueForPixel(0));a.delay=0<t?p(i,r):f(i,r)},t.updateResetZoom=function(e){e.resetZoom=function(){d.each(e.scales,function(e){var t=e.options.time,i=e.options.realtime,n=e.options.ticks;t&&(t.min=e.originalOptions.time.min,t.max=e.originalOptions.time.max),i&&(i.duration=e.originalOptions.realtime.duration,i.delay=e.originalOptions.realtime.delay),n&&(n.min=e.originalOptions.ticks.min,n.max=e.originalOptions.ticks.max)}),e.update({duration:0})}}}(e),i});