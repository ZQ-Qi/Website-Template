/*
* MultiSelect v0.8
* Copyright (c) 2012 Louis Cuny
*
* This program is free software. It comes without any warranty, to
* the extent permitted by applicable law. You can redistribute it
* and/or modify it under the terms of the Do What The Fuck You Want
* To Public License, Version 2, as published by Sam Hocevar. See
* http://sam.zoy.org/wtfpl/COPYING for more details.
*/
(function(e){var t={init:function(t){this.settings={disabledClass:"disabled",selectCallbackOnInit:false,keepOrder:false,dblClick:false};if(t){this.settings=e.extend(this.settings,t)}var n=this;n.css("position","absolute").css("left","-9999px");return n.each(function(){var t=e(this);if(t.next(".ms-container").length==0){t.attr("id",t.attr("id")?t.attr("id"):"ms-"+Math.ceil(Math.random()*1e3));var r=e('<div id="ms-'+t.attr("id")+'" class="ms-container"></div>'),i=e('<div class="ms-selectable"></div>'),s=e('<div class="ms-selection"></div>'),o=e('<ul class="ms-list"></ul>'),u=e('<ul class="ms-list"></ul>');t.data("settings",n.settings);var a=null,f=null,l=0,c=0;t.find("optgroup,option").each(function(){if(e(this).is("optgroup")){a=e(this).attr("label");f="ms-"+t.attr("id")+"-optgroup-"+l;o.append(e('<li class="ms-optgroup-container" id="'+f+'"><ul class="ms-optgroup"><li class="ms-optgroup-label">'+a+"</li></ul></li>"));l++}else{var r=e(this).attr("class")?" "+e(this).attr("class"):"";var i=e('<li class="ms-elem-selectable'+r+'" ms-value="'+e(this).val()+'">'+e(this).text()+"</li>");if(e(this).attr("title"))i.attr("title",e(this).attr("title"));if(e(this).attr("disabled")||t.attr("disabled")){i.attr("disabled","disabled");i.addClass(n.settings.disabledClass)}if(n.settings.dblClick){i.dblclick(function(){t.multiSelect("select",e(this).attr("ms-value"))})}else{i.click(function(){t.multiSelect("select",e(this).attr("ms-value"))})}var s=f?o.children("#"+f).find("ul").first():o;s.append(i)}});if(n.settings.selectableHeader){i.append(n.settings.selectableHeader)}i.append(o);if(n.settings.selectedHeader){s.append(n.settings.selectedHeader)}s.append(u);r.append(i);r.append(s);t.after(r);t.find("option:selected").each(function(){t.multiSelect("select",e(this).val(),"init")});e(".ms-elem-selectable",o).on("mouseenter",function(){e("li",r).removeClass("ms-hover");e(this).addClass("ms-hover")}).on("mouseout",function(){e("li",r).removeClass("ms-hover")});o.on("focusin",function(){e(this).addClass("ms-focus");u.focusout()}).on("focusout",function(){e(this).removeClass("ms-focus");e("li",r).removeClass("ms-hover")});u.on("focusin",function(){e(this).addClass("ms-focus")}).on("focusout",function(){e(this).removeClass("ms-focus");e("li",r).removeClass("ms-hover")});t.on("focusin",function(){o.focus()}).on("focusout",function(){o.removeClass("ms-focus");u.removeClass("ms-focus")});t.onKeyDown=function(n,i){var s=e("."+i+" li:visible:not(.ms-optgroup-label, .ms-optgroup-container)",r),a=s.length,f=e("."+i+" li.ms-hover",r),l=e("."+i+" li:visible:not(.ms-optgroup-label, .ms-optgroup-container)",r).index(f),h=s.first().outerHeight(),p=Math.ceil(r.outerHeight()/h),d=Math.ceil(p/4);s.removeClass("ms-hover");if(n.keyCode==32){var v=i=="ms-selectable"?"select":"deselect";t.multiSelect(v,f.first().attr("ms-value"))}else if(n.keyCode==40){var m=l+1!=a?l+1:0,g=s.eq(m);g.addClass("ms-hover");if(m>d){c+=h}else if(m==0){c=0}e("."+i+" ul",r).scrollTop(c)}else if(n.keyCode==38){var y=l-1>=0?l-1:a-1,b=s.eq(y);s.removeClass("ms-hover");b.addClass("ms-hover");if(a-y+1<d){c=h*(a-d)}else{c-=h}e("."+i+" ul",r).scrollTop(c)}else if(n.keyCode==37||n.keyCode==39){if(o.hasClass("ms-focus")){o.focusout();u.focusin()}else{o.focusin();u.focusout()}}};t.on("keydown",function(e){if(t.is(":focus")){var n=o.hasClass("ms-focus")?"ms-selectable":"ms-selection";t.onKeyDown(e,n)}})}})},refresh:function(){e("#ms-"+e(this).attr("id")).remove();e(this).multiSelect("init",e(this).data("settings"))},select:function(t,n){var r=this,s=r.find('option[value="'+t+'"]'),o=s.text(),u=s.attr("class"),a=s.attr("title");var f=e('<li class="ms-elem-selected'+(u?" "+u:"")+'" ms-value="'+t+'">'+o+"</li>"),l=e("#ms-"+r.attr("id")+" .ms-selectable ul"),c=e("#ms-"+r.attr("id")+" .ms-selection ul"),h=l.children('li[ms-value="'+t+'"]'),p=null;if(n=="init"){p=!h.hasClass(r.data("settings").disabledClass)&&s.prop("selected")}else{p=!h.hasClass(r.data("settings").disabledClass);r.focus()}if(p&&c.children('li[ms-value="'+t+'"]').length==0){var d=h.parent(".ms-optgroup");if(d.length>0)if(d.children(".ms-elem-selectable:not(:hidden)").length==1)d.children(".ms-optgroup-label").hide();h.addClass("ms-selected");h.hide();s.prop("selected",true);if(a){f.attr("title",a)}if(h.hasClass(r.data("settings").disabledClass)){f.addClass(r.data("settings").disabledClass)}else{if(r.data("settings").dblClick){f.dblclick(function(){r.multiSelect("deselect",e(this).attr("ms-value"))})}else{f.click(function(){r.multiSelect("deselect",e(this).attr("ms-value"))})}}var v=c.children(".ms-elem-selected");if(n!="init"&&r.data("settings").keepOrder&&v.length>0){var m=function(e){elems=l.children(".ms-elem-selectable");return elems.index(elems.closest('[ms-value="'+e+'"]'))};var g=m(f.attr("ms-value"));if(g==0)c.prepend(f);else{for(i=g-1;i>=0;i--){if(v[i]&&m(e(v[i]).attr("ms-value"))<g){e(v[i]).after(f);break}else if(i==0){e(v[i]).before(f)}}}}else{c.append(f)}f.on("mouseenter",function(){e("li",c).removeClass("ms-hover");e(this).addClass("ms-hover")}).on("mouseout",function(){e("li",c).removeClass("ms-hover")});if(n=="select_all"&&d.children(".ms-elem-selectable").length>0){d.children(".ms-optgroup-label").hide()}if(n!="init"||r.data("settings").selectCallbackOnInit){r.trigger("change");c.trigger("change");l.trigger("change");if(typeof r.data("settings").afterSelect=="function"&&(n!="init"||r.data("settings").selectCallbackOnInit)){r.data("settings").afterSelect.call(this,t,o)}}}},deselect:function(t){var n=this,r=e("#ms-"+n.attr("id")+" .ms-selection ul"),i=n.find('option[value="'+t+'"]'),s=r.children('li[ms-value="'+t+'"]');if(s){r.focusin();var o=e("#ms-"+n.attr("id")+" .ms-selectable ul"),r=e("#ms-"+n.attr("id")+" .ms-selection ul"),u=o.children('li[ms-value="'+t+'"]'),s=r.children('li[ms-value="'+t+'"]');var a=u.parent(".ms-optgroup");if(a.length>0){a.children(".ms-optgroup-label").addClass("ms-collapse").show();a.children(".ms-elem-selectable:not(.ms-selected)").show()}i.prop("selected",false);u.show();u.removeClass("ms-selected");s.remove();r.trigger("change");o.trigger("change");n.trigger("change");if(typeof n.data("settings").afterDeselect=="function"){n.data("settings").afterDeselect.call(this,t,s.text())}}},select_all:function(t){var n=this,r=e("#ms-"+n.attr("id")+" .ms-selectable ul");n.find("option:not(:selected)").each(function(){var i=e(this).val();if(t){var s=r.children('li[ms-value="'+i+'"]');if(s.filter(":visible").length>0){n.multiSelect("select",i,"select_all")}}else{n.multiSelect("select",i,"select_all")}})},deselect_all:function(){var t=this,n=e("#ms-"+t.attr("id")+" .ms-selection ul");t.find("option:selected").each(function(){t.multiSelect("deselect",e(this).val(),"deselect_all")})}};e.fn.multiSelect=function(e){if(t[e]){return t[e].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof e==="object"||!e){return t.init.apply(this,arguments)}else{if(console.log)console.log("Method "+e+" does not exist on jquery.multiSelect")}return false}})(jQuery)